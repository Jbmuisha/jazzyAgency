{% extends "adminView.html" %}
{% block content %}
<div class="containerGenerale">
    <div id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>
    <div class="header_container">
        <div class="hiddendBt">
            <button class="bt3n bt3n-primary" id="newInvestor">New investor</button>
        </div>

        <div class="contractGenerator">
            <button class="bt3n bt3n-primary">Generate contract</button>

        </div>
        <div class="input_container" style="display: none;">
            <form id="investorForm" method="POST" action="{{ url_for('investiseur') }}">
                {{ form.hidden_tag() }}
                <input type="hidden" id="edit_mode" name="edit_mode" value="false">
                <input type="hidden" id="investor_id" name="investor_id" value="">
                <div class="form-group">
                    {{ form.investor_name.label }}
                    {{ form.investor_name(class_="form-control") }}
                    {% for error in form.investor_name.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_email.label }}
                    {{ form.investor_email(class_="form-control") }}
                    {% for error in form.investor_email.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_phone.label }}
                    {{ form.investor_phone(class_="form-control") }}
                    {% for error in form.investor_phone.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_address.label }}
                    {{ form.investor_address(class_="form-control") }}
                    {% for error in form.investor_address.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.type_of_investment.label }}
                    {{ form.type_of_investment(class_="form-control") }}
                    {% for error in form.type_of_investment.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_amount.label }}
                    {{ form.investor_amount(class_="form-control", step="0.01") }}
                    {% for error in form.investor_amount.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_status.label }}
                    {{ form.investor_status(class_="form-control") }}
                    {% for error in form.investor_status.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.investor_date.label }}
                    {{ form.investor_date(class_="form-control") }}
                    {% for error in form.investor_date.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Add Investment</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn"
                        style="display: none;">Cancel</button>
                </div>
            </form>



        </div>

        <div class="invister_Table">
            <table>
                <thead>
                    <tr>
                        <th>investor name</th>
                        <th>investor email</th>
                        <th>investor phone</th>
                        <th>investor address</th>
                        <th>type of investment</th>
                        <th>investor amount</th>
                        <th>investor status</th>
                        <th>investor date</th>
                        <th> investor benefits percentage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for investor in investors %}
                    <tr>
                        <td>{{ investor.invastiseur_name }}</td>
                        <td>{{ investor.invastiseur_email }}</td>
                        <td>{{ investor.invasteur_phone }}</td>
                        <td>{{ investor.invasteur_address }}</td>
                        <td>{{ investor.invasteur_type }}</td>
                        <td>{{ "%.2f"|format(investor.invasteur_amount) }}</td>
                        <td>{{ investor.invasteur_status }}</td>
                        <td>{{ investor.invasteur_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ "%.2f"|format(investor.invasteur_benefits_percentage) }}</td>
                        <td>{{ "%.2f"|format(investor.platform_benefits) }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-investor" data-id="{{ investor.id }}"
                                data-name="{{ investor.invastiseur_name }}"
                                data-email="{{ investor.invastiseur_email }}"
                                data-phone="{{ investor.invasteur_phone }}"
                                data-address="{{ investor.invasteur_address }}"
                                data-type="{{ investor.invasteur_type }}"
                                data-amount="{{ '%.2f'|format(investor.invasteur_amount) }}"
                                data-status="{{ investor.invasteur_status }}"
                                data-date="{{ investor.invasteur_date.strftime('%Y-%m-%d') if investor.invasteur_date else '' }}">
                                Edit
                            </button>
                            <form action="{{ url_for('delete_investiseur', id=investor.id) }}" method="POST"
                                style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this investor?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const newInvestorBtn = document.getElementById('newInvestor');
        const formContainer = document.querySelector('.input_container');
        const form = document.getElementById('investorForm');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const editModeInput = document.getElementById('edit_mode');
        const investorIdInput = document.getElementById('investor_id');

        // Toggle form visibility
        newInvestorBtn.addEventListener('click', () => {
            if (formContainer.style.display === 'none' || !formContainer.style.display) {
                resetForm();
                formContainer.style.display = 'block';
                newInvestorBtn.textContent = 'Close Form';
            } else {
                formContainer.style.display = 'none';
                newInvestorBtn.textContent = 'New Investor';
            }
        });

        // Handle edit button clicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-investor')) {
                e.preventDefault();
                const btn = e.target;

                // Set form to edit mode
                editModeInput.value = 'true';
                investorIdInput.value = btn.dataset.id;

                // Fill form with investor data
                document.getElementById('investor_name').value = btn.dataset.name;
                document.getElementById('investor_email').value = btn.dataset.email;
                document.getElementById('investor_phone').value = btn.dataset.phone;
                document.getElementById('investor_address').value = btn.dataset.address;
                document.getElementById('type_of_investment').value = btn.dataset.type;
                document.getElementById('investor_amount').value = btn.dataset.amount;
                document.getElementById('investor_status').value = btn.dataset.status;
                document.getElementById('investor_date').value = btn.dataset.date;

                // Update UI
                submitBtn.textContent = 'Update Investment';
                cancelBtn.style.display = 'inline-block';

                // Show form if hidden
                if (formContainer.style.display === 'none') {
                    formContainer.style.display = 'block';
                    newInvestorBtn.textContent = 'Close Form';
                }

                // Scroll to form
                formContainer.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Handle cancel button
        cancelBtn.addEventListener('click', () => {
            resetForm();
        });

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const isEdit = editModeInput.value === 'true';
            const url = isEdit ? `/edit/${investorIdInput.value}` : '/investiseur';

            // Create form data object
            const formData = new FormData(form);
            const formDataObj = {};
            formData.forEach((value, key) => {
                formDataObj[key] = value;
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: new URLSearchParams(formDataObj).toString()
                });

                if (response.redirected) {
                    // If server redirected, follow the redirect
                    window.location.href = response.url;
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    showFlashMessage(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showFlashMessage(data.message || 'An error occurred', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showFlashMessage('An error occurred while processing your request', 'danger');
            }
        });

        function resetForm() {
            form.reset();
            editModeInput.value = 'false';
            investorIdInput.value = '';
            submitBtn.textContent = 'Add Investment';
            cancelBtn.style.display = 'none';
        }

        function showFlashMessage(message, type) {
            const flashDiv = document.getElementById('flash-messages');
            if (!flashDiv) return;

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
            flashDiv.appendChild(alert);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }
    });
</script>




{% endblock %}