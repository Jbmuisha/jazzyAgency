{% extends "adminView.html" %}
{% block content %}

<!-- Make sure Font Awesome is loaded for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    .badge {
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        display: inline-block;
    }

    .badge.role {
        background-color: #4a90e2;
    }

    .badge.status-active {
        background-color: #4CAF50;
    }

    .badge.status-inactive {
        background-color: #f44336;
    }
</style>

<div class="main-area">
    <div class="user-manager-container">
        <div class="header">
            <h2>User Management</h2>
            <button id="toggleFormBtn" class="add-user-button">+ Add New User</button>
        </div>

        <!-- Add/Edit User Form -->
        <div class="add-user-form" id="addUserForm" style="display: none;">
            <form id="userForm" action="/add_user" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="user_id" id="user_id" value="">
                <div class="form-row">
                    <label for="username">Full Name</label>
                    <input type="text" name="username" id="username" placeholder="Enter full name" required>
                </div>
                <div class="form-row">
                    <label for="email">Email</label>
                    <input type="email" name="email" id="email" placeholder="Enter email" required>
                </div>
                <div class="form-row" id="passwordRow">
                    <label for="password">Password</label>
                    <input type="password" name="password" id="password" placeholder="Enter password" required>
                </div>
                <div class="form-row">
                    <label for="role">User Role</label>
                    <select name="role" id="role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="employee">Employee</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="image">Attach Avatar Image</label>
                    <input type="file" name="image" id="image" accept="image/*">
                    <div style="margin-top: 10px;">
                        <img id="avatarPreview" src="" alt="Avatar Preview"
                            style="max-width: 100px; display: none; border-radius: 50%;" />
                    </div>
                </div>
                <button type="submit" class="submit-btn" id="formSubmitBtn">Add User</button>
                <button type="button" id="cancelEditBtn" style="display:none; margin-left:10px;">Cancel</button>
            </form>
        </div>

        <!-- User Cards -->
        <div class="user-card-grid">
            {% for user in users %}
            <div class="user-card" id="user-{{ user.id }}">
                <div style="position: relative;">
                    <div class="user-avatar"
                        style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; position: relative;">
                        {% if user.image %}
                        <img src="{{ url_for('uploaded_file', filename=user.image) }}"
                            alt="{{ user.username }}'s avatar" style="width: 100%; height: 100%; object-fit: cover;"
                            onerror="this.onerror=null; this.style.display='none';">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/default-avatar.png') }}" alt="Default avatar"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% endif %}
                        <div class="edit-overlay"
                            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; cursor: pointer;"
                            data-user-id="{{ user.id }}">
                            <i class="fas fa-camera" style="color: white; font-size: 20px;"></i>
                        </div>
                    </div>
                    <form id="profile-pic-form-{{ user.id }}" style="display: none;">
                        <input type="file" id="profile-picture-{{ user.id }}" name="profile_picture" accept="image/*"
                            data-user-id="{{ user.id }}">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                    </form>
                </div>

                <div class="user-info" style="flex: 1; margin-left: 15px;">
                    <div class="editable-field" data-field="username" data-user-id="{{ user.id }}">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1em;" class="editable">{{ user.username }}</h4>
                        <input type="text" class="form-control edit-input" value="{{ user.username }}"
                            style="display: none;">
                    </div>

                    <div class="editable-field" data-field="email" data-user-id="{{ user.id }}">
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 0.9em;" class="editable">{{ user.email }}
                        </p>
                        <input type="email" class="form-control edit-input" value="{{ user.email }}"
                            style="display: none;">
                    </div>

                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px;">
                        <div class="editable-field" data-field="role" data-user-id="{{ user.id }}">
                            <span class="badge role editable">
                                {{ user.role|capitalize }}
                            </span>
                            {% if user.is_active %}
                            <span class="badge active">
                                Active
                            </span>
                            {% else %}
                            <span class="badge inactive">
                                Inactive
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-action edit" title="Edit" data-id="{{ user.id }}"
                            data-username="{{ user.username }}" data-email="{{ user.email }}"
                            data-role="{{ user.role }}" data-image="{{ user.image_url }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form action="/delete/{{ user.id }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn-action delete" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        // Show/hide edit overlay on avatar hover and handle clicks
        document.addEventListener('DOMContentLoaded', function () {
            const userAvatars = document.querySelectorAll('.user-avatar');

            // Handle file input changes
            document.querySelectorAll('input[type="file"][name="profile_picture"]').forEach(input => {
                input.addEventListener('change', function () {
                    const userId = this.getAttribute('data-user-id');
                    if (this.files && this.files.length > 0) {
                        updateProfilePicture(userId);
                    }
                });
            });

            userAvatars.forEach(avatar => {
                const overlay = avatar.querySelector('.edit-overlay');
                if (!overlay) return;

                // Show/hide overlay on hover
                avatar.addEventListener('mouseenter', () => {
                    overlay.style.display = 'flex';
                });

                avatar.addEventListener('mouseleave', () => {
                    overlay.style.display = 'none';
                });

                // Handle click on overlay
                overlay.addEventListener('click', function () {
                    const userId = this.getAttribute('data-user-id');
                    const fileInput = document.getElementById(`profile-picture-${userId}`);
                    if (fileInput) {
                        fileInput.click();
                    }
                });
            });

            // Make fields editable on click
            document.querySelectorAll('.editable').forEach(element => {
                element.addEventListener('click', function () {
                    const fieldContainer = this.closest('.editable-field');
                    if (!fieldContainer) return;

                    const input = fieldContainer.querySelector('.edit-input');
                    const display = fieldContainer.querySelector('.editable');

                    if (input && display) {
                        display.style.display = 'none';
                        input.style.display = 'block';
                        input.focus();

                        const saveOnBlur = function () {
                            input.style.display = 'none';
                            display.style.display = '';
                            updateUserField(
                                fieldContainer.dataset.userId,
                                fieldContainer.dataset.field,
                                input.value
                            );
                            input.removeEventListener('blur', saveOnBlur);
                        };

                        input.addEventListener('blur', saveOnBlur);

                        input.addEventListener('keypress', function (e) {
                            if (e.key === 'Enter') {
                                input.blur();
                            }
                        });
                    }
                });
            });
        });

        // Update user field via AJAX
        async function updateUserField(userId, field, value) {
            try {
                const formData = new FormData();
                formData.append('user_id', userId);
                formData.append(field, value);

                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) throw new Error('Update failed');

                // Update the displayed value
                const displayElement = document.querySelector(`.editable-field[data-user-id="${userId}"][data-field="${field}"] .editable`);
                if (displayElement) {
                    displayElement.textContent = value;

                    // If this is the username field, also update the avatar alt text
                    if (field === 'username') {
                        const avatarImg = document.querySelector(`#user-${userId} .user-avatar img`);
                        if (avatarImg) {
                            avatarImg.alt = `${value}'s avatar`;
                        }
                    }
                }

                showFlashMessage('User updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating user:', error);
                showFlashMessage('Failed to update user', 'error');
            }
        }

        // Handle profile picture update
        async function updateProfilePicture(userId) {
            const fileInput = document.getElementById(`profile-picture-${userId}`);
            const form = document.getElementById(`profile-pic-form-${userId}`);

            if (!fileInput.files.length) return;

            const formData = new FormData(form);

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) throw new Error('Upload failed');

                // Update the displayed image
                const avatarImg = document.querySelector(`#user-${userId} .user-avatar img`);
                if (avatarImg) {
                    // Add a timestamp to force image reload
                    const timestamp = new Date().getTime();
                    avatarImg.src = `${avatarImg.src.split('?')[0]}?t=${timestamp}`;
                }

                showFlashMessage('Profile picture updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating profile picture:', error);
                showFlashMessage('Failed to update profile picture', 'error');
            }
        }

        // Show flash messages
        function showFlashMessage(message, type) {
            // Create or find flash message container
            let flashContainer = document.querySelector('.flash-messages');
            if (!flashContainer) {
                flashContainer = document.createElement('div');
                flashContainer.className = 'flash-messages';
                flashContainer.style.position = 'fixed';
                flashContainer.style.top = '20px';
                flashContainer.style.right = '20px';
                flashContainer.style.zIndex = '1000';
                document.body.appendChild(flashContainer);
            }

            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `alert alert-${type}`;
            messageElement.style.padding = '10px 20px';
            messageElement.style.marginBottom = '10px';
            messageElement.style.borderRadius = '4px';
            messageElement.style.color = 'white';
            messageElement.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
            messageElement.textContent = message;

            // Add to container and auto-remove after 3 seconds
            flashContainer.appendChild(messageElement);
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transition = 'opacity 0.5s';
                setTimeout(() => messageElement.remove(), 500);
            }, 3000);
        }
    </script>

    <style>
        .user-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .user-card {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 200px;
        }

        @media (min-width: 1200px) {
            .user-card-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .user-card-grid {
                grid-template-columns: 1fr;
            }
        }

        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .editable:hover {
            background-color: #f0f0f0;
        }

        .edit-input {
            width: 100%;
            padding: 2px 5px;
            margin: -2px -5px;
            box-sizing: border-box;
        }

        .badge.role {
            cursor: pointer;
        }
    </style>

    {% endblock %}